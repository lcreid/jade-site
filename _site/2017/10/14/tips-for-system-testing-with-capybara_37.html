<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

<!-- Latest compiled and minified CSS -->
<!-- Bootstrap -->
<!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous"> -->
<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->

<title>Jade Systems Inc Tips for System Testing With Capybara</title>

<link rel="stylesheet" type="text/css" href="/assets/application-12da5280a458727aaeb8688175d798b537281705752dd2bdc70cc4e5d9c5a0c0.css">
<script src="/assets/application-da8cbe894a308e89b1a3507e6010f3ac382cbf2d7b8ae2cdc365edd2b1a50ea9.js" type="text/javascript"></script>
<!-- TODO: Remove the following line as see what happens -->
<link href="https://code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css" rel="stylesheet">
<link href='//fonts.googleapis.com/css?family=Droid+Sans:400,700|Signika+Negative:400,700' rel='stylesheet' type='text/css'>
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

<!-- you don't need to keep this, but it's cool for stats! -->
<meta name="generator" content="jekyll">

  </head>
  <body>
    <div class="container-fluid">
  <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
    <a class="navbar-brand" href="/">Jade Systems Inc</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse">
      <ul class="navbar-nav w-100">
        <li class="nav-item dropdown">
          <a href="#" class="nav-item mx-md-4 dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Knowledgebase</span></a>
          <div class="dropdown-menu">
            <a class="dropdown-item" href="/knowledgebase/">Overview</a>
            <a class="dropdown-item" href="/knowledgebase/static-web-sites.html">Static Web Sites</a>
            <a class="dropdown-item" href="/knowledgebase/search-engines.html">Search Engines</a>
          </div>
        </li>
        <li><a class="nav-item mx-md-4" href="/blog/">Blog</a></li>
        <li><a class="nav-item mx-md-4" href="/contact/">Contact Us</a></li>
      </ul>

      <!-- <form class="form-inline ml-auto">
        <div class="form-group">
          <input type="text" placeholder="Search" class="form-control" id="search" name="query" value="" autocomplete="off" />
        </div>
        <button type="button" class="btn btn-success" id="search-button">Search</button>
      </form> -->
    </div>
  </nav>
</div>

<div class="container">
  <div id="search-results">
    <div id="clear-results" class="clear-button" style="display: block;">&nbsp;</div>
    <ul id="search-results-list"></ul>
    <div id="pagination-outer-container">
      <div id="pagination-inner-container" class="text-center mx-auto">
        <div id="pagination"></div>
      </div>
    </div>
  </div>
</div>

    <section class="mt-2">
      <div class="container">
        <div class="row justify-content-around">
          <div class="col-12 col-lg-8">
            <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Tips for System Testing With Capybara</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2017-10-14T18:35:00+00:00" itemprop="datePublished">Oct 14, 2017
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Larry Reid</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>One of the great challenges of system testing applications is the fact that there are two (or more) independent processes: One to run the test script. The other to run the browser. The actions in the test script and the actions as performed by the browser and the back end, are not necessarily synchronized the way they are in unit or controller tests. </p> <p>This can lead to tests the fail sometimes but not others. They may fail one in ten runs, or they may work on development machines, but fail on the continuous integration platform, or vice versa. <a href="https://martinfowler.com/articles/nonDeterminism.html">Some say</a> that unreliable tests are one of the key things that lead people away from automated testing.</p> <p>I’ve struggled with unreliable tests on Rails applications using <a href="http://teamcapybara.github.io/capybara/">Capybara</a>. Here are some of the solutions I’ve used successfully to make tests more reliable.</p> <h2 id="spinner">Spinner</h2> <p>I like this one because it’s what I should be doing for my users anyway. Anytime something is happening in the background that might take some time, the page should put up a spinner – something that shows that the user should wait. </p> <p>There are lots of spinners available on-line. Some examples are:</p> <ul><li><a href="https://projects.lukehaas.me/css-loaders/">https://projects.lukehaas.me/css-loaders/</a></li><li><a href="http://cssload.net/en/spinners">http://cssload.net/en/spinners</a></li><li><a href="https://www.pexels.com/blog/css-only-loaders/">https://www.pexels.com/blog/css-only-loaders/</a> (the example below is based on the snake spinner from this link)</li></ul> <p>The spinner chosen is not important from the point of view of the test. The tests work on the presence or absence of the spinner element. The basic idea is this:</p> <ol><li>The Capybara test script initiates a JavaScript action that will take some time</li><li>The test browser begins running the JavaScript. The first thing the JavaScript does is put up the spinner by un-hiding the spinner element or adding the spinner element to the DOM. The spinner element should have a distinctive id or class</li><li><p>The Capybara script waits for the spinner to go away by doing something like:</p> <pre class="prettyprint"><code class=" hljs bash">assert_no_selector <span class="hljs-string">".spinner"</span></code></pre></li><li><p>On completing the AJAX request, the JavaScript hides the spinner element or removes it from the DOM</p></li></ol> <p>Here is one example of this technique from a Rails 5.1 application with Turbolinks. All it needs is this JavaScript in the application:</p>   <pre class="prettyprint"><code class="language-JavaScript hljs javascript">$(document).on(<span class="hljs-string">'turbolinks:load'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span><br />  $(<span class="hljs-string">'form.js-submit-on-change'</span>).change(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> {</span><br />    $(<span class="hljs-string">"body"</span>).prepend(<span class="hljs-string">'&lt;div class="spinner"&gt;&lt;/div&gt;'</span>);<br />    $(<span class="hljs-keyword">this</span>).submit();<br />  }).on(<span class="hljs-string">"ajax:success"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span><br />  }).on(<span class="hljs-string">"ajax:error"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span><br />  }).on(<span class="hljs-string">"ajax:complete"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span><br />    $(<span class="hljs-string">".spinner"</span>).remove();<br />  });<br />});</code></pre> <p>And then this in the test case to ensure that the test is synchronized with the browser:</p>   <pre class="prettyprint"><code class="language-Ruby hljs bash">assert_no_selector <span class="hljs-string">".spinner"</span></code></pre> <p>(This JavaScript works for the case where I had forms that I wanted to automatically submit on any change to any of their fields. A traditional form that has a submit button would want to catch the submit event for the form.)</p> <p>For completeness, here’s some SASS to put in <code>assets/stylesheets/spinner.scss</code> to actually show a spinner:</p>   <pre class="prettyprint"><code class="language-CSS hljs scss"><span class="hljs-class">.spinner</span> {<br />  <span class="hljs-at_rule">@<span class="hljs-keyword">extend</span><span class="hljs-preprocessor"> .centered-in-window</span>;</span><br />  <span class="hljs-attribute">z-index</span><span class="hljs-value">: <span class="hljs-number">1</span>;</span><br />  <span class="hljs-attribute">height</span><span class="hljs-value">: <span class="hljs-number">64</span>px;</span><br />  <span class="hljs-attribute">width</span><span class="hljs-value">: <span class="hljs-number">64</span>px;</span><br />  <span class="hljs-attribute">animation</span><span class="hljs-value">: rotate <span class="hljs-number">1</span>s infinite linear;</span><br />  -webkit-<span class="hljs-attribute">animation</span><span class="hljs-value">: rotate <span class="hljs-number">1</span>s infinite linear;</span><br />  <span class="hljs-attribute">border</span><span class="hljs-value">: <span class="hljs-number">8</span>px solid <span class="hljs-hexcolor">#fff</span>;</span><br />  <span class="hljs-attribute">border-right-color</span><span class="hljs-value">: black;</span><br />  <span class="hljs-attribute">border-radius</span><span class="hljs-value">: <span class="hljs-number">50</span>%;</span><br />}<br /><br /><span class="hljs-at_rule">@keyframes<span class="hljs-preprocessor"> rotate</span> {</span><br />  0% {<br />    <span class="hljs-attribute">transform</span><span class="hljs-value">: rotate(<span class="hljs-number">0</span>deg);</span><br />  }<br /><br />  100% {<br />    <span class="hljs-attribute">transform</span><span class="hljs-value">: rotate(<span class="hljs-number">360</span>deg);</span><br />  }<br />}<br /><br /><span class="hljs-at_rule">@-webkit-keyframes<span class="hljs-preprocessor"> rotate</span> {</span><br />  0% {<br />    -webkit-<span class="hljs-attribute">transform</span><span class="hljs-value">: rotate(<span class="hljs-number">0</span>deg);</span><br />  }<br /><br />  100% {<br />    -webkit-<span class="hljs-attribute">transform</span><span class="hljs-value">: rotate(<span class="hljs-number">360</span>deg);</span><br />  }<br />}<br /><br /><span class="hljs-class">.centered-in-window</span> {<br />  <span class="hljs-attribute">position</span><span class="hljs-value">: fixed;</span><br />  <span class="hljs-attribute">top</span><span class="hljs-value">: <span class="hljs-number">50</span>%;</span><br />  <span class="hljs-attribute">left</span><span class="hljs-value">: <span class="hljs-number">50</span>%;</span><br />  <span class="hljs-comment">/* bring your own prefixes */</span><br />  <span class="hljs-attribute">transform</span><span class="hljs-value">: translate(-<span class="hljs-number">50</span>%, -<span class="hljs-number">50</span>%);</span><br />}</code></pre> <p>Don’t forget to add <code>@import "spinner";</code> to your <code>assets/stylesheets/application.scss</code> file.</p>   <h2 id="only-the-back-end-changes">Only the Back End Changes</h2> <p>When the user changes, say, a check box or a drop down menu (a select tag), nothing happens on the browser side other than the change the user made. But often, on the back end something is added, changed, or removed from the database. I tried to use Rails’ <code>assert_difference</code> to test that the right thing happened, but more often than not it would fail, because by the time the database was updated, Capybara had already finished executing the <code>assert_difference</code>.</p> <p>Because of that, my tests were full of examples like this:</p>   <pre class="prettyprint"><code class="language-Ruby hljs livecodeserver">assert_difference <span class="hljs-string">"CisOutage.count"</span> <span class="hljs-built_in">do</span><br />  click_on <span class="hljs-string">"Save"</span><br />  sleep <span class="hljs-number">2</span><br /><span class="hljs-function"><span class="hljs-keyword">end</span></span></code></pre> <p>Each time I put in a <code>sleep 2</code> in my test cases, I was making the test take almost two seconds longer than it needed to. If I didn’t have the <code>sleep 2</code> in the test, the test would fail, because the <code>CisOutage</code> record wouldn’t have been saved in the database by the time the test case evaluated the <code>CisOutage.count</code>.</p> <p>To fix this, I wrote my own <code>assert_difference</code> for system tests, shamelessly stealing from the Rails source and a few items from Capybara. Like the Rails <code>assert_difference</code>, it runs the expressions to get the “before” value, executes the block, then runs the expressions again to get the after values. Unlike the Rails version, if any of the expressions fail to produce the desired result, it sleeps for a tenth of a second, then retries the expressions, until all the expressions produce the desired result, or two seconds pass:</p>   <pre class="prettyprint"><code class="language-Ruby hljs livecodeserver"><span class="hljs-comment">##</span><br /><span class="hljs-comment"># Check for a difference in `expression`, but repeat the check until it's</span><br /><span class="hljs-comment"># true, or two seconds pass. Taken from Rails source and leveraging</span><br /><span class="hljs-comment"># some Capybara stuff.</span><br />def assert_difference(expression, difference = <span class="hljs-number">1</span>, message = nil, &amp;block)<br />  expressions = Array(expression)<br /><br />  exps = expressions.map <span class="hljs-built_in">do</span> |e|<br />    e.respond_to?(:call) ? e : -&gt; { eval(e, block.binding) }<br />  <span class="hljs-function"><span class="hljs-keyword">end</span></span><br />  <span class="hljs-keyword">before</span> = exps.map(&amp;:call)<br />  <span class="hljs-keyword">after</span> = []<br /><br />  retval = yield<br /><br />  start_time = Capybara::Helpers.monotonic_time<br />  loop <span class="hljs-built_in">do</span><br />    <span class="hljs-keyword">after</span> = exps.map(&amp;:call)<br />    break <span class="hljs-keyword">if</span> <span class="hljs-keyword">before</span>.zip(<span class="hljs-keyword">after</span>).all? { |(b, <span class="hljs-operator">a</span>)| <span class="hljs-operator">a</span> == b + difference } ||<br />             start_time + <span class="hljs-number">2</span> &lt; Capybara::Helpers.monotonic_time<br />    sleep <span class="hljs-number">0.1</span><br />  <span class="hljs-function"><span class="hljs-keyword">end</span></span><br /><br />  expressions.zip(<span class="hljs-keyword">after</span>).each_with_index <span class="hljs-built_in">do</span> |(code, <span class="hljs-operator">a</span>), i|<br />    error  = <span class="hljs-string">"#{code.inspect} didn't change by #{difference}"</span><br />    error  = <span class="hljs-string">"#{message}.\n#{error}"</span> <span class="hljs-keyword">if</span> message<br />    assert_equal(<span class="hljs-keyword">before</span>[i] + difference, <span class="hljs-operator">a</span>, error)<br />  <span class="hljs-function"><span class="hljs-keyword">end</span></span><br /><br />  retval<br /><span class="hljs-function"><span class="hljs-keyword">end</span></span></code></pre> <p>For Rails 5.1, I put this in the <code>ApplicationSystemTestCase</code> class in <code>app/test/application_system_test_case.rb</code>. For Rails 5.0 and 4.x, I would have to put it somewhere else. </p> <p>This code could be improved in many ways, but it was good enough to allow me to remove 40 seconds worth of arbitrary <code>sleep</code> statements in my system test cases.</p> <p>Now my test case looks like this:</p>   <pre class="prettyprint"><code class="language-Ruby hljs livecodeserver">assert_difference <span class="hljs-string">"CisOutage.count"</span> <span class="hljs-built_in">do</span><br />  click_on <span class="hljs-string">"Save"</span><br /><span class="hljs-function"><span class="hljs-keyword">end</span></span></code></pre> <p>And the test typically waits at most a couple of tenths of a second before succeeding.</p>   <h2 id="only-the-order-changes">Only the Order Changes</h2> <p>To test “latest first/earliest first” buttons, and similar actions, I had to go beyond a simple <code>assert_text</code> on the page. At first I tried getting all the list items within the list I was interested in, like this:</p>   <pre class="prettyprint"><code class="language-Ruby hljs livecodeserver">click_link <span class="hljs-string">"Oldest First"</span><br />notes = all(<span class="hljs-string">"li.note"</span>)<br /><span class="hljs-operator">within</span>(notes[<span class="hljs-number">0</span>]) <span class="hljs-built_in">do</span><br />  assert_text <span class="hljs-string">"Note B"</span><br />  assert_text <span class="hljs-string">"1 day ago"</span><br />  assert_no_link <span class="hljs-string">"Edit"</span><br />  assert_text <span class="hljs-string">"Can Edit CIs/Outages"</span><br /><span class="hljs-function"><span class="hljs-keyword">end</span></span></code></pre> <p>This would fail if Capybara happened to grab the list <em>before</em> the back end had replied to the browser. More often than not, I found Capybara would populate the <code>notes</code> variable with nodes from the page <em>before</em> the back end responded with the re-ordered list. In the best case, I would simply get test failures. In other cases, Capybara would actually throw errors (the dreaded “stale node” error). This is because once the browser gets the response from the back end, the nodes in <code>notes</code> will no longer be on the current page of the browser.</p> <p>My fix was to use a more specific selector to take advantage of <a href="http://www.rubydoc.info/github/teamcapybara/capybara#asynchronous-javascript-ajax-and-friends">Capybara’s waiting behaviour</a>. This method works for one specific case I had:</p>   <pre class="prettyprint"><code class="language-Ruby hljs livecodeserver">  def assert_synchronized(<span class="hljs-keyword">text</span>, ordinal = <span class="hljs-number">0</span>)<br />    assert_selector <span class="hljs-string">"li.note:nth-of-type(#{ordinal + 1}) .note-body"</span>, <span class="hljs-keyword">text</span>: <span class="hljs-keyword">text</span><br />  <span class="hljs-function"><span class="hljs-keyword">end</span></span></code></pre> <p>This finds the <code>(ordinal + 1)</code>th list item, and then if it has class <code>note</code>, finds all nodes with class <code>note-body</code> with the <code>li</code>, and checks to see if they have the desired text. </p> <p>When I put this <code>assert_synchronized</code> call somewhere in the test case, Capybara checks that the first item in the list has the text I expect, and will do its standard waiting behaviour before proceeding with the rest of the test. </p> <p>I was using 0-based indexes in the rest of the code, but CSS selectors are 1-based, which is why the <code>ordinal + 1</code>. Also, in a more general case I’d have to make sure I was in the right list, but on this page there was only one list. The actual selector would be different for every page or case. The above is just one example.</p> <p>Here’s how I fixed the above test case:</p>   <pre class="prettyprint"><code class="language-Ruby hljs livecodeserver">click_link <span class="hljs-string">"Oldest First"</span><br />assert_synchronized(<span class="hljs-string">"Note B"</span>)<br />notes = all(<span class="hljs-string">"li.note"</span>)<br /><span class="hljs-operator">within</span>(notes[<span class="hljs-number">0</span>]) <span class="hljs-built_in">do</span><br />  assert_text <span class="hljs-string">"Note B"</span><br />  assert_text <span class="hljs-string">"1 day ago"</span><br />  assert_no_link <span class="hljs-string">"Edit"</span><br />  assert_text <span class="hljs-string">"Can Edit CIs/Outages"</span><br /><span class="hljs-function"><span class="hljs-keyword">end</span></span></code></pre> <p>I ran into a couple of challenges with this approach:</p> <ul><li>The <code>nth-of-type(x)</code> selector is literally on the type, AKA HTML tag, and not the other selectors. In other words, something like <code>li.note:nth-of-type(1)</code> gets the first <code>li</code> regardless of its classes, then checks to see if the <code>li</code> has class <code>note</code>. So if the list is mixed and the first <code>li</code> does not have class <code>note</code>, the selector returns nothing</li><li>I had a mixed list as described above, where not every <code>li</code> had the same class. To work around the problem, I was looking at the second item in the list. But the list only had three items in it, so looking at the second item wasn’t synchronizing Capybara with the back end. It took me a while before the light bulb when on and I realized why my test was getting out of sync</li></ul>
  </div><a class="u-url" href="/2017/10/14/tips-for-system-testing-with-capybara_37.html" hidden></a>
</article>

          </div>
        </div>
      </div>
    </section>
    <div class="fixed-bottom bg-white">
  <hr>
  <footer class="text-center mb-2">
    This site was built by Jade Systems Inc using
    <a href="https://jekyllrb.com">Jekyll</a>.
    Layout and styling by <a href="https://getbootstrap.com">Bootstrap</a>.
    <!-- Search by <%= link_to("Solr", "http://lucene.apache.org/solr", target: "_blank") %>.
    Crawl by <%= link_to("Nutch", "http://nutch.apache.org/", target: "_blank") %>. -->
  </footer>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-1728165-2', 'jadesystems.ca');
    ga('send', 'pageview');
  </script>

  <script type="text/javascript" src="/js/jquery.simplePagination.js"></script>
  <script src="/js/jadesystems_namespace.js"></script>
  <script src="/js/dev.js"></script>
  <script src="/js/search.js"></script>
</div>

  </body>
</html>
