<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

<!-- Latest compiled and minified CSS -->
<!-- Bootstrap -->
<!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous"> -->
<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->

<title>Jade Systems Inc Switching to Headless Chrome for Rails System Tests</title>

<link rel="stylesheet" type="text/css" href="/assets/application-12da5280a458727aaeb8688175d798b537281705752dd2bdc70cc4e5d9c5a0c0.css">
<script src="/assets/application-da8cbe894a308e89b1a3507e6010f3ac382cbf2d7b8ae2cdc365edd2b1a50ea9.js" type="text/javascript"></script>
<!-- TODO: Remove the following line as see what happens -->
<link href="https://code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css" rel="stylesheet">
<link href='//fonts.googleapis.com/css?family=Droid+Sans:400,700|Signika+Negative:400,700' rel='stylesheet' type='text/css'>
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

<!-- you don't need to keep this, but it's cool for stats! -->
<meta name="generator" content="jekyll">

  </head>
  <body>
    <div class="container-fluid">
  <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
    <a class="navbar-brand" href="/">Jade Systems Inc</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse">
      <ul class="navbar-nav w-100 mx-md-4">
        <li class="nav-item dropdown">
          <a href="#" class="nav-item dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Knowledgebase</span></a>
          <div class="dropdown-menu">
            <a class="dropdown-item" href="/knowledgebase.html">Overview</a>
            <a class="dropdown-item" href="/knowledgebase/static-web-sites.html">Static Web Sites</a>
            <a class="dropdown-item" href="/knowledgebase/search-engines.html">Search Engines</a>
          </div>
        </li>
        <li><a class="nav-item mx-md-4" href="/blog.html">Blog</a></li>
        <li><a class="nav-item mx-md-4" href="/contact.html">Contact Us</a></li>
      </ul>

      <!-- <form class="form-inline ml-auto">
        <div class="form-group">
          <input type="text" placeholder="Search" class="form-control" id="search" name="query" value="" autocomplete="off" />
        </div>
        <button type="button" class="btn btn-success" id="search-button">Search</button>
      </form> -->
    </div>
  </nav>
</div>

<div class="container">
  <div id="search-results">
    <div id="clear-results" class="clear-button" style="display: block;">&nbsp;</div>
    <ul id="search-results-list"></ul>
    <div id="pagination-outer-container">
      <div id="pagination-inner-container" class="text-center mx-auto">
        <div id="pagination"></div>
      </div>
    </div>
  </div>
</div>

    <section class="mt-2">
      <div class="container">
        <div class="row justify-content-around">
          <div class="col-12 col-lg-8">
            <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Switching to Headless Chrome for Rails System Tests</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2017-11-01T02:10:00+00:00" itemprop="datePublished">Nov 1, 2017
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Larry Reid</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="introduction">Introduction</h2> <p>I recently switched a Rails 5.1 application’s system tests from <a href="https://github.com/teamcapybara/capybara">Capybara</a>, <a href="https://github.com/teampoltergeist/poltergeist">Poltergeist</a>, and <a href="http://phantomjs.org/">PhantomJS</a>, to Capybara, Selenium, and headless Chrome. We run the development and test environments of the application on a Vagrant box running Ubuntu 16.04 server.</p> <p>With the release of headless Chrome, <a href="https://github.com/ariya/phantomjs/issues/15105">PhantomJS is no longer being developed or maintained</a>. It also used a different browser engine that the major browsers, and I was noticing that some test cases didn’t run exactly like they would in a real browser. So when I saw that there was a <a href="https://github.com/rails/rails/pull/30930">pull request</a> in to Rails to change to Selenium and headless Chrome, I thought it was time to try it myself.</p>   <h2 id="installation">Installation</h2> <p>The first thing I did was to install Google Chrome from a Google repository, so it’s easy to get updates: </p>   <pre class="prettyprint"><code class=" hljs lasso">wget <span class="hljs-attribute">-q</span> <span class="hljs-attribute">-O</span> <span class="hljs-subst">-</span> https:<span class="hljs-comment">//dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add</span><br />echo <span class="hljs-string">'deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main'</span> <span class="hljs-subst">|</span> sudo tee /etc/apt/sources<span class="hljs-built_in">.</span><span class="hljs-built_in">list</span><span class="hljs-built_in">.</span>d/google<span class="hljs-attribute">-chrome</span><span class="hljs-built_in">.</span><span class="hljs-built_in">list</span><br />sudo apt<span class="hljs-attribute">-get</span> update<br />sudo apt<span class="hljs-attribute">-get</span> install google<span class="hljs-attribute">-chrome</span><span class="hljs-attribute">-stable</span></code></pre>   <h2 id="configuration">Configuration</h2> <p>(Note that this configuration will change if/when <a href="https://github.com/rails/rails/pull/30930">Rails comes with configuration for headless Chrome</a>.)</p> <p>I set up the configuration in <code>test/application_system_test_case.rb</code>. The Rails 5.1 <code>driven_by</code> allows some options to be set, but I couldn’t figure out how to set the options I needed, so I registered a separate driver for headless Chrome:</p>   <pre class="prettyprint"><code class=" hljs avrasm">  Capybara<span class="hljs-preprocessor">.register</span>_driver(:headless_chrome) do |app|<br />    capabilities = Selenium::WebDriver::Remote::Capabilities<span class="hljs-preprocessor">.chrome</span>(<br />      <span class="hljs-preprocessor"># This makes logs available, but doesn't cause them to appear</span><br />      <span class="hljs-preprocessor"># in real time on the console</span><br />      loggingPrefs: {<br />        browser: <span class="hljs-string">"ALL"</span>,<br />        client: <span class="hljs-string">"ALL"</span>,<br />        driver: <span class="hljs-string">"ALL"</span>,<br />        server: <span class="hljs-string">"ALL"</span><br />      }<br />    )<br /><br />    options = Selenium::WebDriver::Chrome::Options<span class="hljs-preprocessor">.new</span><br />    options<span class="hljs-preprocessor">.add</span>_argument(<span class="hljs-string">"window-size=1400,1200"</span>)<br />    options<span class="hljs-preprocessor">.add</span>_argument(<span class="hljs-string">"headless"</span>)<br />    options<span class="hljs-preprocessor">.add</span>_argument(<span class="hljs-string">"disable-gpu"</span>)<br /><br />    Capybara::Selenium::Driver<span class="hljs-preprocessor">.new</span>(<br />      app,<br />      browser: :chrome,<br />      desired_capabilities: capabilities,<br />      options: options<br />    )<br />  end<br /><br />  driven_by :headless_chrome</code></pre> <p>The arguments for <code>"headless"</code> and <code>"disable-gpu"</code> were necessary to make testing with headless Chrome work. I had to set the window size, because the default window size caused my application’s menu to collapse to a mobile device menu (I’m using Bootstrap 4).</p>   <h2 id="upgrade-capybara">Upgrade Capybara</h2> <p>My  <code>Gemfile</code> had the version of Capybara locked down. I found that a lot of problems went away simply by taking away the version constraint in the <code>Gemfile</code> and letting <code>bundle upgrade capybara --conservative</code> do its thing.</p>   <h2 id="fillin-doesnt-fire-change-event"><code>fill_in</code> Doesn’t Fire Change Event</h2> <p>I had some JavaScript that ran when input fields changed, via the <code>changed</code> event. I had to add a newline to the end of the input text for force the change event to fire:</p>   <pre class="prettyprint"><code class=" hljs bash">fill_<span class="hljs-keyword">in</span> <span class="hljs-string">"Fragment"</span>, with: <span class="hljs-string">"Outage B\n"</span></code></pre>   <h2 id="fillin-date-time-field-with-doesnt-work"><code>fill_in</code> Date Time Field With “” Doesn’t Work</h2> <p>Filling in a date time field with “” to clear it worked with Poltergeist/PhantomJS. With Selenium and headless Chrome it gives:</p>   <pre class="prettyprint"><code class=" hljs lasso">Selenium<span class="hljs-tag">::WebDriver</span><span class="hljs-tag">::Error</span><span class="hljs-tag">::InvalidElementStateError</span>: invalid element state: Element must be user<span class="hljs-attribute">-editable</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">to</span> clear it<span class="hljs-built_in">.</span></code></pre> <p>So I changed the places where I had to clear a date or date time field to this instead:</p>   <pre class="prettyprint"><code class=" hljs ruby">find_field(<span class="hljs-string">"Outages Before"</span>).send_keys <span class="hljs-symbol">:delete</span></code></pre>   <h2 id="fillin-date-field-with-date-works-differently"><code>fill_in</code> Date Field With Date Works Differently</h2> <p>Selenium and headless Chrome seem to process <code>fill_in</code> of a date field more like what the user would experience. My tests that worked with Poltergeist and PhantomJS didn’t work with headless Chrome and Selenium, although part of the problem may have been with the <code>change</code> event triggers I had on the date fields.</p> <p>I got the tests to work by (mysteriously) entering the date as “12312017”, in other words, in the date order used by only one country in the whole known universe. I still had to assert against dates in the format “yyyy-mm-dd”. </p> <p>I also discovered that PhantomJS and/or Poltergeist was more forgiving about date formats in asserts, so I had to change a bunch of asserts where I had used the “dd/mm/yyyy” format.</p>   <h2 id="alerts">Alerts</h2> <p>Alerts aren’t automatically dismissed, so I had to go through all my tests and put an <code>assert_accept</code> block around actions like deletes, like this:</p>   <pre class="prettyprint"><code class=" hljs livecodeserver">accept_alert <span class="hljs-built_in">do</span><br />  click_link <span class="hljs-string">"Delete"</span><br /><span class="hljs-function"><span class="hljs-keyword">end</span></span></code></pre>   <h2 id="empty-divs">Empty <code>div</code>s</h2> <p>Selenium and Chrome seem to treat an empty <code>div</code> as if it’s not visible. I had to change some selectors that were looking for an empty <code>div</code> to something like this:</p>   <pre class="prettyprint"><code class=" hljs ruby">assert_selector <span class="hljs-string">".test-home-page"</span>, <span class="hljs-symbol">visible:</span> <span class="hljs-symbol">:any</span></code></pre>   <h2 id="no-browser-logs-in-real-time-or-by-default">No Browser Logs in Real Time (or by Default)</h2> <p>Browser logs don’t appear by default, and don’t appear in real time. To show what was in the browser log, I had to put the following in the test script:</p>   <pre class="prettyprint"><code class=" hljs avrasm">puts page<span class="hljs-preprocessor">.driver</span><span class="hljs-preprocessor">.manage</span><span class="hljs-preprocessor">.get</span>_log(:browser)</code></pre> <p>To even have the browser log available at all, I had to set up the configuration as described at the beginning of this post.</p>   <h2 id="performance">Performance</h2> <p>My system tests take about 50 % longer with headless Chrome, compared to PhantomJS. </p>
  </div><a class="u-url" href="/2017/11/01/switching-to-headless-chrome-for-rails_31.html" hidden></a>
</article>

          </div>
        </div>
      </div>
    </section>
    <div class="fixed-bottom bg-white">
  <hr>
  <footer class="text-center mb-2">
    This site was built by Jade Systems Inc using
    <a href="https://jekyllrb.com">Jekyll</a>.
    Layout and styling by <a href="https://getbootstrap.com">Bootstrap</a>.
    <!-- Search by <%= link_to("Solr", "http://lucene.apache.org/solr", target: "_blank") %>.
    Crawl by <%= link_to("Nutch", "http://nutch.apache.org/", target: "_blank") %>. -->
  </footer>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-1728165-2', 'jadesystems.ca');
    ga('send', 'pageview');
  </script>

  <script type="text/javascript" src="/js/jquery.simplePagination.js"></script>
  <script src="/js/jadesystems_namespace.js"></script>
  <script src="/js/dev.js"></script>
  <script src="/js/search.js"></script>
</div>

  </body>
</html>
