<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

<!-- Latest compiled and minified CSS -->
<!-- Bootstrap -->
<!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous"> -->
<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->

<title>Jade Systems Inc Self-Referential, Polymorphic, STI, Decorated, Many-to-Many Relationship in Rails 4</title>

<link rel="stylesheet" type="text/css" href="/assets/application-146b96968f8ce2b4e222756cbac1ba0369401179a547c2d6627685b87935d7f1.css">
<script type="text/javascript" src="/assets/application-74a2961b03c490e748858cd3444a085a30c1a45206d1f86e1c0519328803240f.js"></script>
<!-- TODO: Remove the following line as see what happens -->
<link href="https://code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css" rel="stylesheet">
<link href='//fonts.googleapis.com/css?family=Droid+Sans:400,700|Signika+Negative:400,700' rel='stylesheet' type='text/css'>
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

<!-- you don't need to keep this, but it's cool for stats! -->
<meta name="generator" content="jekyll">

  </head>
  <body>
    <div class="container-fluid">
  <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
    <a class="navbar-brand" href="/">Jade Systems Inc</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse">
      <ul class="navbar-nav w-100">
        <li class="nav-item dropdown">
          <a href="#" class="nav-item mx-md-4 dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Knowledgebase</span></a>
          <div class="dropdown-menu">
            <a class="dropdown-item" href="/knowledgebase/">Overview</a>
            <a class="dropdown-item" href="/knowledgebase/static-web-sites.html">Static Web Sites</a>
            <a class="dropdown-item" href="/knowledgebase/search-engines.html">Search Engines</a>
          </div>
        </li>
        <li><a class="nav-item mx-md-4" href="/blog/">Blog</a></li>
        <li><a class="nav-item mx-md-4" href="/contact/">Contact Us</a></li>
      </ul>

      <!-- <form class="form-inline ml-auto">
        <div class="form-group">
          <input type="text" placeholder="Search" class="form-control" id="search" name="query" value="" autocomplete="off" />
        </div>
        <button type="button" class="btn btn-success" id="search-button">Search</button>
      </form> -->
    </div>
  </nav>
</div>

<div class="container">
  <div id="search-results">
    <div id="clear-results" class="clear-button" style="display: block;">&nbsp;</div>
    <ul id="search-results-list"></ul>
    <div id="pagination-outer-container">
      <div id="pagination-inner-container" class="text-center mx-auto">
        <div id="pagination"></div>
      </div>
    </div>
  </div>
</div>

    <section class="mt-2">
      <div class="container">
        <div class="row justify-content-around">
          <div class="col-12 col-lg-8">
            <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Self-Referential, Polymorphic, STI, Decorated, Many-to-Many Relationship in Rails 4</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2014-01-07T23:47:00-06:00" itemprop="datePublished">Jan 7, 2014
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Larry Reid</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="preamble">Preamble</h2>I wanted to model connections à la connections in LinkedIn or Facebook in a Rails application. This means a many-to-many association between instances of the same class. That caused me some grief trying to get it hooked up right because you can’t rely on Rails to figure everything out.<br />The other trick in my application is that the people involved in the connections might be users who have registered to use the application, or they might be people created by a registered user, but who aren’t registered to user the application. <br />Concretely, and hopefully more clearly, I have “users”, who have registered, and I have people who can be involved connections. In my app the people who aren’t registered users are “patients”.<br />In the course of trying to get this all to work I stumbled across three approaches to this type of problem:<br /><ol><li>Polymorphic classes</li><li>Single Table Inheritance (STI)</li><li><a href="http://en.wikipedia.org/wiki/Decorator_pattern">Decorator pattern</a></li></ol>The combination of the many-to-many combined with the two classes took a lot of work to get straight. The <a href="http://guides.rubyonrails.org/association_basics.html%20and%20migrations:%20http://guides.rubyonrails.org/migrations.html">Rails Guides</a> were a great starting point, but I find that specifying Rails associations can be tricky if it’s not completely straightforward, and especially when you start chaining them together.<br />In the end, I decided to go with the Decorator pattern. But I’ll start with the one I threw out first: Polymorphic.<br /><h2 id="polymorphic">Polymorphic</h2>I got pretty far with polymorphic associations, but I couldn’t figure out how I was going to get a list of all people (patients and users) connected to another person. I could either get all patients or all users from the methods that the Rails associations gave me, but not a list of all together.<br />I realized in writing the preamble above that I probably should have realized that what I was trying to model wasn’t really a polymorphic situation. Polymorphic in the examples I saw was used to connect an object to another object from any one of a number of unrelated classes. Of course, hindsight is 20/20.<br /><a href="http://www.brentmc79.com/posts/polymorphic-many-to-many-associations-in-rails">This post</a> convinced me that trying to get a list of all people wasn’t going to come naturally from a polymorphic approach, so I stopped pursuing it.<br /><div class="se-section-delimiter"></div><h2 id="single-table-inheritance">Single Table Inheritance</h2>I got fired up about single table inheritance (STI) as I was reading about how to make the polymorphic approach work. A good brief write up is here: <a href="http://blog.thirst.co/post/14885390861/rails-single-table-inheritance">http://blog.thirst.co/post/14885390861/rails-single-table-inheritance</a>. The Railscast is here: <a href="http://railscasts.com/episodes/394-sti-and-polymorphic-associations">http://railscasts.com/episodes/394-sti-and-polymorphic-associations</a> (sorry, it’s a pro Railscast so it’s behind a paywall).<br />Others say I shouldn’t do STI. People say it can cause problems. One problem is if the type of an object will change, and change because of user input, it’s hard to handle. The view and controller are fixed to a certain object, so you can’t change the object type based on user input. <br />So here’s the code. First, create the models:<br /><pre><code>rails g model person name:string type:string provider:string uid:string<br />rails g model link person_a:references person_b:references b_is:string<br /></code></pre>person.rb<br /><pre><code>class Person &lt; ActiveRecord::Base<br />  has_many :links, foreign_key: "person_a_id"<br />  has_many :people, :through =&gt; :links, :source =&gt; :person_b<br />  scope :patients, -&gt; { where(type: "Patient") }<br />  scope :users, -&gt; { where(type: "User") }<br />end<br /></code></pre>user.rb (obviously there will be functionality here, but this is what I needed to get the associations to work):<br /><pre><code>class User &lt; Person<br />end<br /></code></pre>patient.rb (as with user.rb, functionality will come later):<br /><pre><code>class Patient &lt; Person<br />end<br /></code></pre>link.rb<br /><pre><code>class Link &lt; ActiveRecord::Base<br />  belongs_to :person_a, class_name: "Person"<br />  belongs_to :person_b, class_name: "Person"<br />end<br /></code></pre>It was a little hard to get the associations to work. The key to making the <code>has_many :links,...</code> in <code>person.rb</code> work was the <code>, class_name: "Person"</code> on the association in <code>link.rb</code>. <br />With the above, I can do things like:<br /><pre><code>person = Person.find(1).first<br />person.people.first.name<br />person.people.patients.first.name<br />person.people.users.first.name<br /></code></pre>That’s all pretty sweet, and I really considered using this approach. In fact, I may return to it. There’s a lot left to do with my application. However, I’m pretty sure that I will need to deal with cases like a registered user corresponding to multiple patients (e.g. people get created under different names). Eventually I need a way to consolidate them.<br /><h2 id="decorator">Decorator</h2>In the end, perhaps the simplest was the best. I just decorated a person with an instance of a user when the person is a registered user. (This allows multiple people for a user, which might be useful for consolidating duplicate people.) <br />Here’s what I did:<br />Generate the models:<br /><pre><code>rails g model link person_a:references person_b:references b_is:string<br />rails g model person user:references name:string<br />rails g model user uid:string name:string provider:string<br /></code></pre>person.rb<br /><pre><code>require 'person_helper'<br /><br />class Person &lt; ActiveRecord::Base<br />  belongs_to :user<br />  has_many :links, foreign_key: :person_a_id<br />  has_many :people, through: :links, source: :person_b<br /><br />  include PersonHelper<br />end<br /></code></pre>I thought the person model should have <code>has_one</code> instead of <code>belongs_to</code>, but that would put the foreign key in the wrong model.<br />user.rb<br /><pre><code>require 'person_helper'<br /><br />class User &lt; ActiveRecord::Base<br />  has_many :identities, class_name: "Person"<br />  has_many :links, through: :identities<br />  has_many :people, through: :links, :source =&gt; :person_b<br /><br />  include PersonHelper<br />end<br /></code></pre>lib/person_helper.rb<br /><pre><code>module PersonHelper<br />  def users<br />    people.select { |person| ! person.user_id.nil? }<br />  end<br /><br />  def patients<br />    people.select { |person| person.user_id.nil? }<br />  end<br />end<br /></code></pre>link.rb<br /><pre><code>class Link &lt; ActiveRecord::Base<br />  belongs_to :person_a, class_name: "Person"<br />  belongs_to :person_b, class_name: "Person"<br />end<br /></code></pre>With the above, I can do things like:<br /><pre><code>person = Person.find(1).first<br />person.people.first.name<br />person.patients.first.name<br />person.users.first.name<br />user = User.find(2).first<br />user.users.first.name<br /></code></pre>Again, sweet. Same number of files at the STI version. Instead of subclassing, common functionality is handled by a mixin module.<br /><h2 id="postscript">Postscript</h2>Another thing people don’t seem to like about STI is that it’s easy to end up with a big table full of all sorts of columns used only in a few places. Most modern database management systems aren’t going to waste a significant amount of space for unused columns, so I’m not sure what the problem is.<br />However, it got me thinking if there isn’t a way in Rails to have more than one table under a model. Or more to the point, could you have a table for the base model class, and a different table for each of the subclasses, and have Rails manage all the saving a retrieving.<br />I’m sure I’m not the first person to think of this. But I’m not going to go looking for it right now.<br /><h2 id="other-resources">Other Resources</h2>Rails 4 guides on associations: <a href="http://guides.rubyonrails.org/association_basics.html">http://guides.rubyonrails.org/association_basics.html</a> and migrations: <a href="http://guides.rubyonrails.org/migrations.html">http://guides.rubyonrails.org/migrations.html</a>.<br />Ryan Bates’ Railscast on self-referential associations: <a href="http://railscasts.com/episodes/163-self-referential-association">http://railscasts.com/episodes/163-self-referential-association</a>, and on polymorphic associations: <a href="http://railscasts.com/episodes/154-polymorphic-association">http://railscasts.com/episodes/154-polymorphic-association</a>.
  </div><a class="u-url" href="/2014/01/07/self-referential-polymorphic-sti.html" hidden></a>
</article>

          </div>
        </div>
      </div>
    </section>
    <div class="fixed-bottom bg-white">
  <hr>
  <footer class="text-center mb-2">
    This site was built by Jade Systems Inc using
    <a href="https://jekyllrb.com">Jekyll</a>.
    Layout and styling by <a href="https://getbootstrap.com">Bootstrap</a>.
    <!-- Search by <%= link_to("Solr", "http://lucene.apache.org/solr", target: "_blank") %>.
    Crawl by <%= link_to("Nutch", "http://nutch.apache.org/", target: "_blank") %>. -->
  </footer>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-1728165-2', 'jadesystems.ca');
    ga('send', 'pageview');
  </script>

  <script type="text/javascript" src="/js/jquery.simplePagination.js"></script>
  <script src="/js/jadesystems_namespace.js"></script>
  <script src="/js/dev.js"></script>
  <script src="/js/search.js"></script>
</div>

  </body>
</html>
