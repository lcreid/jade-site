<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

<!-- Latest compiled and minified CSS -->
<!-- Bootstrap -->
<!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous"> -->
<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->

<title>Jade Systems Inc Definitive Guide to Recovering from a Full Disk</title>

<link rel="stylesheet" type="text/css" href="/assets/application-12da5280a458727aaeb8688175d798b537281705752dd2bdc70cc4e5d9c5a0c0.css">
<script src="/assets/application-da8cbe894a308e89b1a3507e6010f3ac382cbf2d7b8ae2cdc365edd2b1a50ea9.js" type="text/javascript"></script>
<!-- TODO: Remove the following line as see what happens -->
<link href="https://code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css" rel="stylesheet">
<link href='//fonts.googleapis.com/css?family=Droid+Sans:400,700|Signika+Negative:400,700' rel='stylesheet' type='text/css'>
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

<!-- you don't need to keep this, but it's cool for stats! -->
<meta name="generator" content="jekyll">

  </head>
  <body>
    <div class="container-fluid">
  <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
    <a class="navbar-brand" href="/">Jade Systems Inc</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse">
      <ul class="navbar-nav w-100">
        <li class="nav-item dropdown">
          <a href="#" class="nav-item mx-md-4 dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Knowledgebase</span></a>
          <div class="dropdown-menu">
            <a class="dropdown-item" href="/knowledgebase/">Overview</a>
            <a class="dropdown-item" href="/knowledgebase/static-web-sites.html">Static Web Sites</a>
            <a class="dropdown-item" href="/knowledgebase/search-engines.html">Search Engines</a>
          </div>
        </li>
        <li><a class="nav-item mx-md-4" href="/blog/">Blog</a></li>
        <li><a class="nav-item mx-md-4" href="/contact/">Contact Us</a></li>
      </ul>

      <!-- <form class="form-inline ml-auto">
        <div class="form-group">
          <input type="text" placeholder="Search" class="form-control" id="search" name="query" value="" autocomplete="off" />
        </div>
        <button type="button" class="btn btn-success" id="search-button">Search</button>
      </form> -->
    </div>
  </nav>
</div>

<div class="container">
  <div id="search-results">
    <div id="clear-results" class="clear-button" style="display: block;">&nbsp;</div>
    <ul id="search-results-list"></ul>
    <div id="pagination-outer-container">
      <div id="pagination-inner-container" class="text-center mx-auto">
        <div id="pagination"></div>
      </div>
    </div>
  </div>
</div>

    <section class="mt-2">
      <div class="container">
        <div class="row justify-content-around">
          <div class="col-12 col-lg-8">
            <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Definitive Guide to Recovering from a Full Disk</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2014-09-30T04:54:00+00:00" itemprop="datePublished">Sep 30, 2014
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Larry Reid</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Cheap, stingy guy that I am, I allocate really small system partitions to my Ubuntu servers. This means that periodically my disk fills up. It fills up because every kernel upgrade takes a fair amount of space, and old kernels aren’t cleaned out automatically. Unfortunately, the disk usually fills up when trying to do an upgrade, so <code class="highlighter-rouge">apt-get</code> fails, and terminates with a partially installed package. You’ll know that has happened when you get a message like this when you run an <code class="highlighter-rouge">apt</code> command:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>E: Unmet dependencies. Try using -f.
</code></pre></div></div>

<p>Once that happens, you can’t use any <code class="highlighter-rouge">apt</code> command.
There’s lots of advice out there about what to do, but the pages I’ve found always seem to leave something out, or assume knowledge of <code class="highlighter-rouge">apt</code> or <code class="highlighter-rouge">dpkg</code> that I don’t have.
So based on the last time this happened, here’s how I plan to recover the next time I run out of space. Warning: lots of Terminal commands coming up. I do everything in the Terminal for a few reasons:</p>

<ul>
  <li>This happens to me most often with servers, as I’m trying to save space, especially for virtual machines. My servers don’t have a GUI</li>
  <li>Terminal works for both desktop and server machines</li>
  <li>It’s easier to document commands for the Terminal</li>
</ul>

<p>First, I have to make sure the problem really is that I’m out of space. (Looking for 0 in the “Avail” column, on the line that has “/” under the “Mounted on” column):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>df -h
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda1       3.7G  3.7G     0 100% /
...
</code></pre></div></div>

<p>Then I find out what version of the kernel I’m running:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>uname -a
Linux ixmucane 3.13.0-24-generic #47-Ubuntu SMP Fri May 2 23:30:00 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux
</code></pre></div></div>

<p>Next, I find out what kernels are installed:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dpkg --list | grep linux-image
</code></pre></div></div>

<p>If I have at least two versions <i>older</i> than the one I’m currently running, I can remove the oldest one (replacing the “n.nn.n-nn” with the version number I want to remove):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo dpkg --purge linux-headers-n.nn.n-nn-generic
sudo dpkg --purge linux-headers-n.nn.n-nn
sudo dpkg --purge linux-image-extra-n.nn.n-nn-generic
sudo dpkg --purge linux-image-n.nn.n-nn-generic
</code></pre></div></div>

<p>This should free up lots of space, but I check again with <code class="highlighter-rouge">df -h</code>. Then run:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt-get -f install
</code></pre></div></div>

<p>If the amount of space it needs is less than what’s available according to <code class="highlighter-rouge">df -h</code>, then I go ahead and finish the install. To be safe, I also do:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt-get update
</code></pre></div></div>

<p>If there’s not enough space, and I have more old versions of the kernel installed, I just repeat the above <code class="highlighter-rouge">dpkg</code> until I have enough space to finish the install.</p>

<p>The above is the happy path. If I didn’t have two versions older than the current running kernel, I would try to remove the partially installed packages. Looking again at the output of:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dpkg --list | grep linux-image
</code></pre></div></div>

<p>if the newest version there is <i>newer</i> than the kernel currently running, then I would try the above <code class="highlighter-rouge">dpkg</code> commands to remove the partially installed packages. Some of them won’t work, of course, since the package isn’t installed, But once all the installed packages are removed, presumably there would more space and I could try:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt-get -f install
</code></pre></div></div>

<p>The reason I want to have two versions older than the current version is in case for some reason the current kernel doesn’t work, I can go back to the previous version. This is a cautious approach. If I’m really stuck, I would remove all versions except the current version. I’d probably make sure that I could boot the current kernel first. I haven’t had to do this and I hope I never do, but…</p>

  </div><a class="u-url" href="/2014/09/30/definitive-guide-to-full-disk.html" hidden></a>
</article>

          </div>
        </div>
      </div>
    </section>
    <div class="fixed-bottom bg-white">
  <hr>
  <footer class="text-center mb-2">
    This site was built by Jade Systems Inc using
    <a href="https://jekyllrb.com">Jekyll</a>.
    Layout and styling by <a href="https://getbootstrap.com">Bootstrap</a>.
    <!-- Search by <%= link_to("Solr", "http://lucene.apache.org/solr", target: "_blank") %>.
    Crawl by <%= link_to("Nutch", "http://nutch.apache.org/", target: "_blank") %>. -->
  </footer>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-1728165-2', 'jadesystems.ca');
    ga('send', 'pageview');
  </script>

  <script type="text/javascript" src="/js/jquery.simplePagination.js"></script>
  <script src="/js/jadesystems_namespace.js"></script>
  <script src="/js/dev.js"></script>
  <script src="/js/search.js"></script>
</div>

  </body>
</html>
