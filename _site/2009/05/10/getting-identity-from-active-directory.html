<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

<!-- Latest compiled and minified CSS -->
<!-- Bootstrap -->
<!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous"> -->
<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->

<title>Jade Systems Inc Getting Identity From Active Directory</title>

<link rel="stylesheet" type="text/css" href="/assets/application-98e9166b77607c63af11de4f07aed958edd44e8355dc75436ac5945ad306053f.css">
<script type="text/javascript" src="/assets/application-bc6cebb457ee48a536dd089669e1fefc9f8a6b424ed4799b4258b566e2ee29d7.js"></script>
<!-- TODO: Remove the following line as see what happens -->
<link href="https://code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css" rel="stylesheet">
<link href='//fonts.googleapis.com/css?family=Droid+Sans:400,700|Signika+Negative:400,700' rel='stylesheet' type='text/css'>
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

<!-- you don't need to keep this, but it's cool for stats! -->
<meta name="generator" content="jekyll">

  </head>
  <body>
    <div class="container-fluid">
  <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
    <a class="navbar-brand" href="/">Jade Systems Inc</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse">
      <ul class="navbar-nav w-100">
        <li class="nav-item dropdown">
          <a href="#" class="nav-item mx-md-4 dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Knowledgebase</span></a>
          <div class="dropdown-menu">
            <a class="dropdown-item" href="/knowledgebase/">Overview</a>
            <a class="dropdown-item" href="/knowledgebase/static-web-sites.html">Static Web Sites</a>
            <a class="dropdown-item" href="/knowledgebase/search-engines.html">Search Engines</a>
          </div>
        </li>
        <li><a class="nav-item mx-md-4" href="/blog/">Blog</a></li>
        <li><a class="nav-item mx-md-4" href="/contact/">Contact Us</a></li>
      </ul>

      <!-- <form class="form-inline ml-auto">
        <div class="form-group">
          <input type="text" placeholder="Search" class="form-control" id="search" name="query" value="" autocomplete="off" />
        </div>
        <button type="button" class="btn btn-success" id="search-button">Search</button>
      </form> -->
    </div>
  </nav>
</div>

<div class="container">
  <div id="search-results">
    <div id="clear-results" class="clear-button" style="display: block;">&nbsp;</div>
    <ul id="search-results-list"></ul>
    <div id="pagination-outer-container">
      <div id="pagination-inner-container" class="text-center mx-auto">
        <div id="pagination"></div>
      </div>
    </div>
  </div>
</div>

    <section class="mt-2">
      <div class="container">
        <div class="row justify-content-around">
          <div class="col-12 col-lg-8">
            <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Getting Identity From Active Directory</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2009-05-10T14:51:00+00:00" itemprop="datePublished">May 10, 2009
      </time>â€¢ <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Larry Reid</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    I needed a test environment where I could test mounting and accessing Windows shares on a Linux machine, using identities and permissions obtained from Active Directory (AD). After the initial setup, I wanted to run a processes periodically in the background, without user intervention. Therefore, having the user enter the password each time wasn't an option. Also, the background process would be run periodically forever in the future. I didn't want to store passwords because the processes would fail after the user changed their password (and it's not a good idea to store passwords anyway).<br /><br />The <a href="http://en.wikipedia.org/wiki/Kerberos_%28protocol%29">Kerberos</a> authentication scheme in Windows and Linux uses tickets, which can be used to prove that a process is acting on behalf of a user. A user gets a ticket by requesting one and providing their password. Until that ticket expires, processes that support Kerberos can be run with the permissions of that user.<br /><br />So let's say we want to access a Windows share as user "testa", which is a <span style="font-style: italic;">Windows</span> user known to the AD server. The Linux machine asks for a ticket for testa, using testa's password. The AD server validates the password and gives the Linux machine a ticket. The Linux machine can then mount the Windows share using Kerberos authentication. Accesses to the files and directories on the share will then be allowed or denied based on testa's permissions.<br /><br />I built an AD server on Windows 2003 Server SP2. The client machine was Ubuntu Desktop Edition 9.04.<br /><br />Here's how I went about it:<br /><ol><li>Build an Active Directory server accepting the defaults. This included allowing it to set up its own DNS server. I already have DNS servers in my network, but I'm not a DNS expert. I've had bad luck changing my DNS setup in the past, so for this test I just let AD do its thing.</li><li>Install required packages on the Linux machine:<br /></li><br />sudo apt-get  install krb5-user keyutils<br /><br /><li>Replace the installed /etc/krb5.conf with the following. You have to replace "my.domain.tld" with your own domain, of course. Be careful to copy uppercase and lowercase:</li><br />[libdefaults]<br />default_realm = MY.DOMAIN.TLD<br />default_checksum = rsa-md5<br /><br /><br />[realms]<br />MY.DOMAIN.TLD = {<br />kdc = ADServer.my.domain.tld<br />}<br /><br />[domain_realm]<br />.my.domain.tld = MY.DOMAIN.TLD<br />my.domain.tld = MY.DOMAIN.TLD<br /><br /><li>Add the following line to /etc/request-key.conf. The order of the lines is important. I put it last and nothing changed. I put it first and everything worked:</li><br />create    cifs.spnego    *    *    /usr/sbin/cifs.upcall %k %d<br /><br /><li>Get a key with kinit. Run kinit with sudo. The ticket you get is for the AD user testa whether you run as sudo or not, but the place that kinit stores the ticket depends on the Linux user who runs kinit. Since the mount command runs as root, you have to get a ticket for root or mount won't find the ticket<br /></li><br />sudo kinit -f testa<br /><br /><li>Mount the share, replacing "FileServer", "Share", and "/tmp/mnt" with appropriate values for your systems:</li><br />sudo mount -t cifs -o sec=krb5i //FileServer/Share /tmp/mnt<br /></ol>For a while I was getting "mount error(2): No such file or directory" when I tried to mount. It was because I hadn't installed the keyutils package.<br /><br />I've tested this up to and including the mount. I haven't finished testing the background process I originally wanted to build. I may modify this post based on my testing experience, so check back later.
  </div><a class="u-url" href="/2009/05/10/getting-identity-from-active-directory.html" hidden></a>
</article>

          </div>
        </div>
      </div>
    </section>
    <div class="fixed-bottom bg-white">
  <hr>
  <footer class="text-center mb-2">
    This site was built by Jade Systems Inc using
    <a href="https://jekyllrb.com">Jekyll</a>.
    Layout and styling by <a href="https://getbootstrap.com">Bootstrap</a>.
    <!-- Search by <%= link_to("Solr", "http://lucene.apache.org/solr", target: "_blank") %>.
    Crawl by <%= link_to("Nutch", "http://nutch.apache.org/", target: "_blank") %>. -->
  </footer>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-1728165-2', 'jadesystems.ca');
    ga('send', 'pageview');
  </script>

  <script type="text/javascript" src="/js/jquery.simplePagination.js"></script>
  <script src="/js/jadesystems_namespace.js"></script>
  <script src="/js/dev.js"></script>
  <script src="/js/search.js"></script>
</div>

  </body>
</html>
